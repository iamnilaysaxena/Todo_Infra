name: Azure-Infra-Deploy
 
on:
  workflow_dispatch:
  
jobs:
  deploy:
    name: Deploy Infra to Azure
    # runs-on: ubuntu-latest 
    runs-on: [self-hosted, Windows, X64]
    defaults:
      run:
        working-directory: environments/development

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3
        # with:
        #   terraform_version: 1.10.5
      - name: Terraform Init
        # working-directory: environment/dev
        run: terraform init
 
      - name: Terraform Format Check
        run: terraform fmt
 
      - name: Terraform Validate
        # working-directory: environment/dev
        run: terraform validate
 
      - name: Run TFSec (Security Scan)
        # uses: aquasecurity/tfsec-action@v1.28.1
        run: tfsec .
 
      - name: Terraform Plan
        # working-directory: environment/dev
        run: terraform plan
 
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        # working-directory: environment/dev
        run: terraform apply -auto-approve
